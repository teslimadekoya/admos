{% extends 'dashboard/base.html' %}
{% block title %}Orders - Admos Place{% endblock %}
{% block content %}
<div class="dashboard-page">
    <div class="page-header">
        <h1>Orders</h1>
        <div class="header-controls">
            <div class="sort-controls">
                <label for="sort-select">Sort by:</label>
                <select id="sort-select" onchange="changeSort(this.value)">
                    <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Most Recent</option>
                    <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>Oldest First</option>
                </select>
            </div>
            <div class="order-stats">
        <div class="stat-card">
            <span class="stat-number">{{ pending_orders_count }}</span>
            <span class="stat-label">Pending (Paid)</span>
        </div>
                <div class="stat-card">
                    <span class="stat-number">{{ on_the_way_orders_count }}</span>
                    <span class="stat-label">On the Way</span>
                </div>
                       <a href="{% url 'dashboard:delivered_orders' %}" class="stat-card stat-link">
                           <span class="stat-number">{{ todays_delivered_count }}</span>
                           <span class="stat-label">Today's Delivered</span>
                       </a>
            </div>
        </div>
    </div>

    <!-- Paid Orders Ready for Preparation -->
    {% if pending_orders %}
    <div class="order-section">
        <div class="section-header">
            <h2><i class="fas fa-clock"></i> Pending (Paid)</h2>
            <span class="count-badge">{{ pending_orders_count }}</span>
        </div>

        <div class="orders-grid">
            {% for order in pending_orders %}
            <div class="order-card">
                <div class="order-header">
                    <span class="order-id">#{{ order.id }}</span>
                    <span class="order-time">{{ order.created_at|date:"g:i A" }}</span>
                </div>
                
                <div class="customer-details">
                    <h4>Customer Information</h4>
                    <p><strong>Name:</strong> {{ order.user.first_name }} {{ order.user.last_name }}</p>
                    <p><strong>Phone:</strong> {{ order.user.phone_number }}</p>
                    <p><strong>Delivery Address:</strong> {{ order.delivery_address|default:"Not provided" }}</p>
                    <p><strong>Contact Phone:</strong> {{ order.contact_phone|default:"Not provided" }}</p>
                </div>
                
                <div class="order-status">
                    <span class="status-badge status-in-progress">{{ order.status }}</span>
                </div>
                
                <div class="order-total">₦ {{ order.total|floatformat:0 }}</div>
                <div class="order-actions">
                    <a href="{% url 'dashboard:order_details' order.id %}" class="btn btn-outline">View Details</a>
                    {% if user.role != 'accountant' %}
                    <form method="post" action="{% url 'dashboard:update_order_status' order.id %}" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="status" value="On the Way">
                        <button type="submit" class="btn btn-primary" onclick="return confirm('Send order #{{ order.id }} for delivery?')">
                            <i class="fas fa-truck"></i> Send for Delivery
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}


    <!-- On the Way -->
    {% if on_the_way_orders %}
    <div class="order-section">
        <div class="section-header">
            <h2><i class="fas fa-truck"></i> On the Way</h2>
            <span class="count-badge">{{ on_the_way_orders_count }}</span>
        </div>
        
        <div class="orders-grid">
            {% for order in on_the_way_orders %}
            <div class="order-card">
                <div class="order-header">
                    <span class="order-id">#{{ order.id }}</span>
                    <span class="order-time">{{ order.created_at|date:"g:i A" }}</span>
                </div>
                
                <div class="customer-details">
                    <h4>Customer Information</h4>
                    <p><strong>Name:</strong> {{ order.user.first_name }} {{ order.user.last_name }}</p>
                    <p><strong>Phone:</strong> {{ order.user.phone_number }}</p>
                    <p><strong>Delivery Address:</strong> {{ order.delivery_address|default:"Not provided" }}</p>
                    <p><strong>Contact Phone:</strong> {{ order.contact_phone|default:"Not provided" }}</p>
                </div>
                
                <div class="order-status">
                    <span class="status-badge status-in-progress">{{ order.status }}</span>
                </div>
                
                <div class="order-total">₦ {{ order.total|floatformat:0 }}</div>
                <div class="order-actions">
                    <a href="{% url 'dashboard:order_details' order.id %}" class="btn btn-outline">View Details</a>
                    {% if user.role != 'accountant' %}
                    <form method="post" action="{% url 'dashboard:update_order_status' order.id %}" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="status" value="Pending">
                        <button type="submit" class="btn btn-warning" onclick="return confirm('Unsend order #{{ order.id }} for delivery?')">
                            <i class="fas fa-undo"></i> Unsend for Delivery
                        </button>
                    </form>
                    <form method="post" action="{% url 'dashboard:update_order_status' order.id %}" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="status" value="Delivered">
                        <button type="submit" class="btn btn-success" onclick="return confirm('Mark order #{{ order.id }} as delivered?')">
                            <i class="fas fa-check"></i> Mark Delivered
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Empty State -->
    {% if not pending_orders and not on_the_way_orders %}
    <div class="empty-state">
        <i class="fas fa-shopping-cart"></i>
        <h3>No orders to process</h3>
        <p>All caught up! New orders will appear here when customers place them.</p>
    </div>
    {% endif %}
</div>

<script>
function changeSort(sortValue) {
    const url = new URL(window.location);
    url.searchParams.set('sort', sortValue);
    window.location.href = url.toString();
}
</script>
{% endblock %}